<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>guestroom</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      background: #fafafa;
      color: #333;
      line-height: 1.6;
    }

    h1 {
      font-weight: 400;
      color: #666;
      margin-bottom: 30px;
    }

    textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
      resize: vertical;
    }

    .controls {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      align-items: center;
    }

    .counter {
      font-size: 0.85rem;
      color: #999;
    }

    button {
      padding: 6px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: #333;
      color: #fff;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .messages {
      margin-top: 40px;
      border-top: 1px solid #eee;
      padding-top: 20px;
    }

    .message {
      margin-bottom: 24px;
      padding-bottom: 24px;
      border-bottom: 1px solid #eee;
    }

    .date {
      font-size: 0.8rem;
      color: #999;
      margin-top: 6px;
    }

    .admin-delete {
      margin-top: 6px;
      background: none;
      color: #c00;
      font-size: 0.8rem;
      padding: 0;
    }
  </style>
</head>
<body>

<h1>guestroom</h1>

<textarea id="messageInput" placeholder="Leave a message..." maxlength="280"></textarea>

<div class="controls">
  <span id="counter" class="counter">0 / 280</span>
  <button id="sendBtn" disabled>Send</button>
</div>

<div class="messages" id="messages"></div>

<script>
/* ---------------- CONFIG ---------------- */

const SUPABASE_URL = "https://vxejmnxqwnmxcmsvxkjl.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_3rpDu6-tw90RYNpgVqq_mA_DmxbBNYX";
const EDGE_DELETE_URL =
  "https://vxejmnxqwnmxcmsvxkjl.supabase.co/functions/v1/delete-message";
const ADMIN_PASSWORD = "ionatropic2004";

/* ---------------- INIT ---------------- */

const supabase = supabaseJs.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

const isAdmin =
  new URLSearchParams(window.location.search).get("admin") === ADMIN_PASSWORD;

const input = document.getElementById("messageInput");
const counter = document.getElementById("counter");
const sendBtn = document.getElementById("sendBtn");
const messagesEl = document.getElementById("messages");

/* ---------------- INPUT ---------------- */

input.addEventListener("input", () => {
  const len = input.value.length;
  counter.textContent = `${len} / 280`;
  sendBtn.disabled = len === 0 || len > 280;
});

/* ---------------- LOAD ---------------- */

async function loadMessages() {
  const { data, error } = await supabase
    .from("messages")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) {
    messagesEl.innerHTML = "<p>Failed to load messages.</p>";
    return;
  }

  if (!data.length) {
    messagesEl.innerHTML = "<p>No messages yet.</p>";
    return;
  }

  messagesEl.innerHTML = data.map(msg => `
    <div class="message">
      <div>${escapeHtml(msg.content)}</div>
      <div class="date">${formatDate(msg.created_at)}</div>
      ${isAdmin ? `
        <button class="admin-delete" onclick="deleteMessage('${msg.id}')">
          delete
        </button>` : ""}
    </div>
  `).join("");
}

/* ---------------- SEND ---------------- */

sendBtn.addEventListener("click", async () => {
  const content = input.value.trim();
  if (!content) return;

  sendBtn.disabled = true;

  await supabase.from("messages").insert([{ content }]);

  input.value = "";
  counter.textContent = "0 / 280";
  sendBtn.disabled = true;

  loadMessages();
});

/* ---------------- DELETE (ADMIN ONLY) ---------------- */

async function deleteMessage(id) {
  if (!isAdmin) return;

  const res = await fetch(EDGE_DELETE_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      id,
      admin: ADMIN_PASSWORD
    })
  });

  if (!res.ok) {
    alert("Delete failed");
    return;
  }

  loadMessages();
}

/* ---------------- UTILS ---------------- */

function escapeHtml(str) {
  const div = document.createElement("div");
  div.textContent = str;
  return div.innerHTML;
}

function formatDate(d) {
  return new Date(d).toLocaleString();
}

/* ---------------- START ---------------- */

loadMessages();
</script>

</body>
</html>