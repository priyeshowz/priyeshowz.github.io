<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>guestroom</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      line-height: 1.6;
      color: #333;
      background: #fafafa;
      padding: 20px;
      max-width: 600px;
      margin: 0 auto;
    }

    h1 {
      font-size: 1.5rem;
      font-weight: 400;
      margin-bottom: 30px;
      color: #666;
    }

    .compose { margin-bottom: 40px; }

    textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: inherit;
      font-size: 1rem;
      resize: vertical;
      margin-bottom: 8px;
    }

    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .counter { font-size: 0.9rem; color: #999; }
    .counter.over { color: #d00; }

    button {
      padding: 8px 24px;
      background: #333;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
    }

    button:disabled { background: #ccc; }

    .messages {
      border-top: 1px solid #eee;
      padding-top: 20px;
    }

    .message {
      margin-bottom: 30px;
      padding-bottom: 30px;
      border-bottom: 1px solid #f0f0f0;
      position: relative;
    }

    .message-content {
      margin-bottom: 8px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .message-date {
      font-size: 0.85rem;
      color: #999;
    }

    .message-delete {
      position: absolute;
      top: 0;
      right: 0;
      padding: 4px 12px;
      background: #d00;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .admin-indicator {
      display: inline-block;
      margin-left: 10px;
      padding: 4px 8px;
      background: #d00;
      color: #fff;
      font-size: 0.75rem;
      border-radius: 3px;
    }

    .loading { text-align: center; color: #999; padding: 20px; }
    .error { color: #d00; background: #fee; padding: 12px; border-radius: 4px; }
  </style>
</head>
<body>

<h1>
  guestroom
  <span class="admin-indicator" id="adminIndicator" style="display:none;">ADMIN</span>
</h1>

<div class="compose">
  <textarea id="messageInput" placeholder="Leave a message..." maxlength="280"></textarea>
  <div class="controls">
    <span class="counter" id="charCounter">0 / 280</span>
    <button id="sendBtn" disabled>Send</button>
  </div>
</div>

<div id="errorContainer"></div>
<div class="messages" id="messagesContainer">
  <div class="loading">Loading messages...</div>
</div>

<script>
const { createClient } = supabase;

const supabaseClient = createClient(
  'https://vxejmnxqwnmxcmsvxkjl.supabase.co',
  'sb_publishable_3rpDu6-tw90RYNpgVqq_mA_DmxbBNYX'
);

const adminPassword = 'ionatropic2004';
const urlParams = new URLSearchParams(window.location.search);
const isAdmin = urlParams.get('admin') === adminPassword;

if (isAdmin) {
  document.getElementById('adminIndicator').style.display = 'inline-block';
}

async function loadMessages() {
  const { data } = await supabaseClient
    .from('messages')
    .select('*')
    .order('created_at', { ascending: false });

  if (!data || data.length === 0) {
    messagesContainer.innerHTML = '<div class="loading">No messages yet.</div>';
    return;
  }

  messagesContainer.innerHTML = data.map(msg => `
    <div class="message">
      ${isAdmin ? `<button class="message-delete" onclick="deleteMessage('${msg.id}')">Delete</button>` : ''}
      <div class="message-content">${escapeHtml(msg.content)}</div>
      <div class="message-date">${formatDate(msg.created_at)}</div>
    </div>
  `).join('');
}

async function deleteMessage(id) {
  if (!confirm('Delete this message?')) return;

  const res = await fetch(
    'https://vxejmnxqwnmxcmsvxkjl.functions.supabase.co/delete-message',
    {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id, admin: adminPassword })
    }
  );

  if (!res.ok) {
    alert('Delete failed');
    return;
  }

  loadMessages();
}

window.deleteMessage = deleteMessage;

function escapeHtml(t) {
  const d = document.createElement('div');
  d.textContent = t;
  return d.innerHTML;
}

function formatDate(d) {
  return new Date(d).toLocaleString();
}

loadMessages();
</script>
</body>
</html>